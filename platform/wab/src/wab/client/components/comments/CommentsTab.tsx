// This is a skeleton starter React component generated by Plasmic.
// This file is owned by you, feel free to edit as you see fit.
import { Dropdown, Menu } from "antd";

import RootComment from "@/wab/client/components/comments/RootComment";
import {
  CommentFilter,
  filterThreads,
  FilterValueToLabel,
  getThreadsFromFocusedComponent,
} from "@/wab/client/components/comments/utils";
import { useViewCtxMaybe } from "@/wab/client/contexts/StudioContexts";
import {
  DefaultCommentsTabProps,
  PlasmicCommentsTab,
} from "@/wab/client/plasmic/plasmic_kit_comments/PlasmicCommentsTab";
import { useStudioCtx } from "@/wab/client/studio-ctx/StudioCtx";
import { isTplNamable } from "@/wab/shared/core/tpls";
import { observer } from "mobx-react";
import * as React from "react";

export const DEFAULT_NOTIFICATION_LEVEL = "mentions-and-replies";
export const notifyAboutKeyToLabel = {
  all: "All comments",
  "mentions-and-replies": "Replies only",
  none: "None",
} as const;

export type CommentsTabProps = DefaultCommentsTabProps;

export const CommentsTab = observer(function CommentsTab(
  props: CommentsTabProps
) {
  const studioCtx = useStudioCtx();
  const viewCtx = useViewCtxMaybe();

  let focusedTpl = viewCtx?.focusedTpl();
  if (!isTplNamable(focusedTpl)) {
    focusedTpl = null;
  }

  const currentComponent = studioCtx.currentComponent;

  const commentsCtx = studioCtx.commentsCtx;

  if (!currentComponent) {
    return null;
  }

  const threads = filterThreads(
    commentsCtx.computedData().allThreads,
    commentsCtx.commentsFilter(),
    studioCtx
  );

  const {
    focusedSubjectThreads,
    focusedComponentThreads,
    otherComponentsThreads,
  } = getThreadsFromFocusedComponent(threads, currentComponent, focusedTpl);

  // We have the focused element threads together, with the focused subject threads first
  const currentFocusThreads = [
    ...focusedSubjectThreads,
    ...focusedComponentThreads,
  ];

  const projectId = studioCtx.siteInfo.id;
  const branchId = studioCtx.branchInfo()?.id;

  const currentNotificationLevel =
    commentsCtx.selfNotificationSettings()?.notifyAbout ??
    DEFAULT_NOTIFICATION_LEVEL;

  return (
    <div
      className={"comments-tab flex-even"}
      style={{
        overflow: "scroll",
      }}
    >
      <PlasmicCommentsTab
        {...props}
        emptySelection={!focusedTpl}
        noComments={Boolean(focusedTpl && !focusedSubjectThreads.length)}
        notificationsButton={{
          wrap: (node) => (
            <Dropdown
              overlay={
                <Menu selectedKeys={[currentNotificationLevel]}>
                  <Menu.ItemGroup title={"Notify me about"}>
                    {Object.entries(notifyAboutKeyToLabel).map(
                      ([key, label]) => (
                        <Menu.Item
                          key={key}
                          onClick={async () => {
                            await studioCtx.appCtx.api.updateNotificationSettings(
                              projectId,
                              branchId,
                              {
                                ...commentsCtx.selfNotificationSettings(),
                                notifyAbout: key as any,
                              }
                            );
                            await commentsCtx.fetchComments();
                          }}
                        >
                          {label}
                        </Menu.Item>
                      )
                    )}
                  </Menu.ItemGroup>
                </Menu>
              }
            >
              {node}
            </Dropdown>
          ),
        }}
        filterButton={{
          props: {
            children: FilterValueToLabel[commentsCtx.commentsFilter()],
          },
          wrap: (node) => (
            <Dropdown
              overlay={
                <Menu selectedKeys={[commentsCtx.commentsFilter()]}>
                  {Object.entries(FilterValueToLabel).map(([key, label]) => (
                    <Menu.Item
                      key={key}
                      onClick={async () => {
                        commentsCtx.setCommentsFilter(key as CommentFilter);
                      }}
                    >
                      {label}
                    </Menu.Item>
                  ))}
                </Menu>
              }
            >
              {node}
            </Dropdown>
          ),
        }}
        selectedSubjectHead={{
          tpl: isTplNamable(focusedTpl) ? focusedTpl : undefined,
          viewCtx,
        }}
        currentThreadsList={{
          children: currentFocusThreads.map((threadComment) => (
            <RootComment
              commentThread={threadComment}
              onThreadSelect={(threadId) =>
                commentsCtx.openCommentThreadDialog(threadId)
              }
            />
          )),
        }}
        restThreadsSection={{
          wrap: (node) => otherComponentsThreads.length > 0 && node,
        }}
        restThreadsList={{
          children: otherComponentsThreads.map((commentThread) => (
            <RootComment
              commentThread={commentThread}
              onThreadSelect={(threadId) =>
                commentsCtx.openCommentThreadDialog(threadId)
              }
            />
          )),
        }}
      />
    </div>
  );
});

export default CommentsTab;
