// This is a skeleton starter React component generated by Plasmic.
// This file is owned by you, feel free to edit as you see fit.
import { Dropdown, Menu } from "antd";

import { apiKey } from "@/wab/client/api";
import { useCommentViews } from "@/wab/client/components/comments/CommentViews";
import {
  getThreadsFromComments,
  getThreadsFromFocusedComponent,
  TplComment,
} from "@/wab/client/components/comments/utils";
import {
  SidebarModal,
  SidebarModalProvider,
} from "@/wab/client/components/sidebar/SidebarModal";
import { useViewCtxMaybe } from "@/wab/client/contexts/StudioContexts";
import {
  DefaultCommentsTabProps,
  PlasmicCommentsTab,
} from "@/wab/client/plasmic/plasmic_kit_comments/PlasmicCommentsTab";
import { useStudioCtx } from "@/wab/client/studio-ctx/StudioCtx";
import { CommentThreadId } from "@/wab/shared/ApiSchema";
import { isTplNamable, summarizeTplNamable } from "@/wab/tpls";
import { observer } from "mobx-react";
import * as React from "react";
import { useState } from "react";
import { mutate } from "swr";

export const DEFAULT_NOTIFICATION_LEVEL = "mentions-and-replies";
export const notifyAboutKeyToLabel = {
  all: "All comments",
  "mentions-and-replies": "Replies only",
  none: "None",
} as const;

// Your component props start with props for variants and slots you defined
// in Plasmic, but you can add more here, like event handlers that you can
// attach to named nodes in your component.
//
// If you don't want to expose certain variants or slots as a prop, you can use
// Omit to hide them:
//
// interface CommentsTabProps extends Omit<DefaultCommentsTabProps, "hideProps1"|"hideProp2"> {
//   // etc.
// }
//
// You can also stop extending from DefaultCommentsTabProps altogether and have
// total control over the props for your component.
export type CommentsTabProps = DefaultCommentsTabProps;

export const CommentsTab = observer(function CommentsTab(
  props: CommentsTabProps
) {
  const studioCtx = useStudioCtx();
  const viewCtx = useViewCtxMaybe();

  const [shownThreadId, setShownThreadId] = useState<
    CommentThreadId | undefined
  >(undefined);

  let focusedTpl = viewCtx?.focusedTpl();
  if (!isTplNamable(focusedTpl)) {
    focusedTpl = null;
  }

  const currentComponent = studioCtx.currentComponent;

  const maybeCommentViews = useCommentViews(studioCtx, viewCtx);

  if (!maybeCommentViews || !currentComponent) {
    return null;
  }

  const {
    allComments,
    userMap,
    renderComment,
    renderFullThread,
    renderPostForm,
    getCurrentVariants,
  } = maybeCommentViews;

  function renderRootComment(threadComments: TplComment[]) {
    const [comment] = threadComments;

    const threadId = comment.threadId;

    return (
      <>
        {renderComment(
          comment,
          comment.label,
          threadComments.length > 1
            ? `${threadComments.length - 1} replies`
            : "Reply",
          async () => {
            const ownerComponent = studioCtx
              .tplMgr()
              .findComponentContainingTpl(comment.subject);
            if (ownerComponent) {
              await studioCtx.setStudioFocusOnTpl(
                ownerComponent,
                comment.subject
              );
              studioCtx.centerFocusedFrame(1);
            }
            setShownThreadId(threadId);
          },
          true
        )}
      </>
    );
  }

  const threads = getThreadsFromComments(allComments);

  const {
    focusedSubjectThreads,
    focusedComponentThreads,
    otherComponentsThreads,
  } = getThreadsFromFocusedComponent(threads, currentComponent, focusedTpl);

  // We have the focused element threads together, with the focused subject threads first
  const currentFocusThreads = [
    ...focusedSubjectThreads,
    ...focusedComponentThreads,
  ];

  const projectId = studioCtx.siteInfo.id;
  const branchId = studioCtx.branchInfo()?.id;
  function refresh() {
    return mutate(apiKey("getComments", projectId, branchId));
  }

  const selfNotificationSettings =
    studioCtx.commentsData?.[0].selfNotificationSettings;
  const currentNotificationLevel =
    selfNotificationSettings?.notifyAbout ?? DEFAULT_NOTIFICATION_LEVEL;
  return (
    <div
      className={"comments-tab flex-even"}
      style={{
        overflow: "scroll",
      }}
    >
      <SidebarModalProvider containerSelector=".comments-tab">
        <PlasmicCommentsTab
          {...props}
          emptySelection={!focusedTpl}
          notificationsButton={{
            props: {
              children: `Notifications: ${notifyAboutKeyToLabel[currentNotificationLevel]}`,
            },
            wrap: (node) => (
              <Dropdown
                overlay={
                  <Menu selectedKeys={[currentNotificationLevel]}>
                    <Menu.ItemGroup title={"Notify me about"}>
                      {Object.entries(notifyAboutKeyToLabel).map(
                        ([key, label]) => (
                          <Menu.Item
                            key={key}
                            onClick={async () => {
                              await studioCtx.appCtx.api.updateNotificationSettings(
                                projectId,
                                branchId,
                                {
                                  ...selfNotificationSettings,
                                  notifyAbout: key as any,
                                }
                              );
                              await refresh();
                            }}
                          >
                            {label}
                          </Menu.Item>
                        )
                      )}
                    </Menu.ItemGroup>
                  </Menu>
                }
              >
                {node}
              </Dropdown>
            ),
          }}
          currentlySelectedTitle={{
            wrap: focusedTpl ? (it) => it : () => null,
          }}
          currentlySelectedSubject={{
            children:
              focusedTpl && viewCtx
                ? summarizeTplNamable(
                    focusedTpl,
                    viewCtx.effectiveCurrentVariantSetting(focusedTpl).rsh()
                  )
                : undefined,
          }}
          currentlySelectedPrefix={
            currentFocusThreads.length > 0
              ? {}
              : { children: "Comment on selected" }
          }
          currentThreadsList={{
            children: currentFocusThreads.map((threadComments) =>
              renderRootComment(threadComments)
            ),
          }}
          newThreadForm={{
            render: () => (focusedTpl ? renderPostForm() : null),
          }}
          restThreadsSection={{
            wrap: (node) => otherComponentsThreads.length > 0 && node,
          }}
          restThreadsList={{
            children: otherComponentsThreads.map((threadComments) =>
              renderRootComment(threadComments)
            ),
          }}
        />
        {shownThreadId && (
          <SidebarModal
            show
            onClose={() => setShownThreadId(undefined)}
            title={threads.get(shownThreadId)?.[0]?.label}
          >
            {renderFullThread(threads.get(shownThreadId) ?? [], shownThreadId)}
          </SidebarModal>
        )}
      </SidebarModalProvider>
    </div>
  );
});

export default CommentsTab;
