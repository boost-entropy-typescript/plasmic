// This is a skeleton starter React component generated by Plasmic.
// This file is owned by you, feel free to edit as you see fit.
import { Menu, notification, Popover, Tooltip } from "antd";
import { observer } from "mobx-react-lite";
import * as React from "react";
import { DraggableProvidedDragHandleProps } from "react-beautiful-dnd";
import { spawn } from "../../../common";
import {
  CodeComponent,
  getComponentDisplayName,
  getDefaultComponentKind,
  getDefaultComponentLabel,
  isHostLessCodeComponent,
} from "../../../components";
import {
  compareComponentPropsWithMeta,
  UnknownComponentError,
} from "../../../shared/code-components/code-components";
import { AddItemType } from "../../definitions/insertables";
import { reportError } from "../../ErrorNotifications";
import ComponentIcon from "../../plasmic/plasmic_kit/PlasmicIcon__Component";
import { StudioCtx } from "../../studio-ctx/StudioCtx";
import { ViewCtx } from "../../studio-ctx/view-ctx";
import ListItem from "../ListItem";
import { MenuBuilder } from "../menu-builder";
import {
  showModalToRefreshCodeComponentProps,
  tryRemapComponent,
} from "../modals/codeComponentModals";
import { DraggableInsertable } from "../studio/add-drawer/DraggableInsertable";
import { Matcher } from "../view-common";
import { Icon } from "../widgets/Icon";
import { buildCommonComponentMenuItems } from "./LeftComponentsPanel";

export const CodeComponentRow = observer(function ComponentRow(props: {
  studioCtx: StudioCtx;
  component: CodeComponent;
  matcher: Matcher;
  onFindReferences: () => void;
  isDragging?: boolean;
  dragHandleProps?: DraggableProvidedDragHandleProps;
  indent: number;
}) {
  const {
    studioCtx,
    component,
    matcher,
    onFindReferences,
    isDragging,
    dragHandleProps,
    indent,
  } = props;
  const overlay = () => {
    const builder = new MenuBuilder();

    builder.genSection(undefined, (push) => {
      push(
        <Menu.Item
          key="refresh"
          onClick={() => {
            const registration = studioCtx.codeComponentsRegistry
              .getRegisteredCodeComponentsMap()
              .get(component.name);
            if (!registration) {
              notification.error({
                message: "Code component not registered",
              });
              return;
            }
            const { meta } = registration;

            const diffsOrError = compareComponentPropsWithMeta(
              studioCtx.site,
              component,
              meta
            );
            diffsOrError.match({
              success: (diffs) => {
                if (
                  [
                    diffs.addedProps,
                    diffs.removedProps,
                    diffs.updatedProps,
                  ].some((i) => i.length > 0)
                ) {
                  spawn(
                    showModalToRefreshCodeComponentProps([
                      { ...diffs, component },
                    ])
                  );
                } else {
                  notification.info({
                    message: `${getComponentDisplayName(
                      component
                    )} is up to date`,
                  });
                }
              },
              failure: (err: UnknownComponentError) => {
                notification.error({
                  message: err.message,
                });
                reportError(err);
              },
            });
          }}
        >
          <strong>Refresh</strong> registered props
        </Menu.Item>
      );
    });

    buildCommonComponentMenuItems(
      builder,
      studioCtx,
      component,
      onFindReferences
    );

    builder.genSection(undefined, (push) => {
      if (isHostLessCodeComponent(component)) {
        return;
      }
      push(
        <Menu.Item
          key="delete"
          onClick={() =>
            tryRemapComponent(
              studioCtx,
              component,
              <>
                Delete code component {getComponentDisplayName(component)} (
                <code>{component.codeComponentMeta.importPath}</code>)
              </>
            )
          }
        >
          <strong>Delete</strong> component
        </Menu.Item>
      );
    });

    return builder.build({ menuName: "code-component-item-menu" });
  };

  const defaultComponentKind = getDefaultComponentKind(
    studioCtx.site,
    component
  );
  return (
    <DraggableInsertable
      sc={studioCtx}
      spec={{
        key: component.uuid,
        label: getComponentDisplayName(component),
        factory: (vc: ViewCtx) => {
          return vc.variantTplMgr().mkTplComponentWithDefaults(component);
        },
        icon: <Icon icon={ComponentIcon} />,
        type: AddItemType.tpl,
      }}
    >
      <Tooltip
        title={<code>{component.codeComponentMeta?.importPath}</code>}
        placement="topRight"
        mouseEnterDelay={1}
      >
        <ListItem
          isDragging={isDragging}
          icon={<Icon icon={ComponentIcon} />}
          menu={overlay}
          dragHandleProps={dragHandleProps}
          hasRightContents
          style={{ paddingLeft: indent * 24 }}
          rightContent={
            <Tooltip title={component.codeComponentMeta.importPath}>
              <code
                style={{
                  textOverflow: "ellipsis",
                  minWidth: 0,
                  overflow: "hidden",
                  whiteSpace: "nowrap",
                }}
              >
                {component.codeComponentMeta.importPath}
              </code>
            </Tooltip>
          }
        >
          {defaultComponentKind ? (
            <Popover
              content={
                <p>
                  <strong>Default component:</strong>{" "}
                  {getDefaultComponentLabel(defaultComponentKind)}
                </p>
              }
            >
              <strong>
                {matcher.boldSnippets(getComponentDisplayName(component))}
              </strong>
            </Popover>
          ) : (
            matcher.boldSnippets(getComponentDisplayName(component))
          )}
        </ListItem>
      </Tooltip>
    </DraggableInsertable>
  );
});
